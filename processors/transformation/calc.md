# ![ ](../../media/app/icons/component-18/component-default-20.svg) Калькулятор

## Описание

Создание новых полей, которые вычисляются по заданной формуле из значений переменных и других полей, в том числе и вычисленных ранее в этом же обработчике. В формуле могут применяться поля входного набора данных, входящие [переменные](../../scenario/variables/README.md), функции.

### Вход

* ![](../../media/app/icons/ports/table-inactive.svg) Входной источник данных (таблица данных).

* ![](../../media/app/icons/ports/optional-input-variable-inactive.svg) Входные переменные (переменные), необязательный.

### Выход

* ![](../../media/app/icons/ports/table-inactive.svg) Выходной набор данных (таблица данных).

## Мастер настройки

Окно настроек содержит области:

 1. [Список выражений](#spisok-vyrazheniy)
 2. [Область кода выражения](#oblast-koda-vyrazheniya)
 3. [Поля/переменные](#polyaperemennye)
 4. [Список функций](#spisok-funktsiy)

### Список выражений

Область предназначена для ввода *выражений - вычисляемых полей, которыми в результате обработки будет дополнен входной набор данных*. Значение выражения в каждой строке набора данных будет вычислено по формуле, заданной в области кода выражения.

Новое выражение можно создать при помощи панели инструментов области или контекстного меню. Операции панели инструментов и контекстного меню:

* ![](../../media/app/icons/toolbar-18/toolbar-18-28.svg) Редактировать - задание параметров выражения;

* ![](../../media/app/icons/toolbar-18/toolbar-18-21.svg) Переместить вверх - поднять выражение на одну позицию вверх по списку;

* ![](../../media/app/icons/toolbar-18/toolbar-18-20.svg) Переместить вниз - опустить выражение на одну позицию вниз по списку;

* ![](../../media/app/icons/toolbar-18/toolbar-18-27.svg) Добавить выражение - добавляет новое выражение с параметрами по умолчанию;

* ![](../../media/app/icons/toolbar-18/toolbar-18-112.svg) Добавить выражение по образцу - добавляет новое выражение с типом данных, описанием и формулой, как у текущего выражения;

* ![](../../media/app/icons/toolbar-18/toolbar-18-8.svg) Удалить выражение - удаляет текущее выражение;

* ![](../../media/app/icons/toolbar-18/toolbar-18-127.svg) Удалить все выражения - удаляет все имеющиеся выражения.

При добавлении и редактировании выражения отображается диалог редактирования параметров. Следующие параметры выражений доступны для изменений:

* Имя - [имя поля](../../data/datasetfieldoptions.md) в выходном наборе данных. Имя должно быть уникальным, начинаться с заглавной или строчной латинской буквы или с символа подчеркивания. Последующие символы имени могут быть такими же, либо цифрами.

* Метка - [метка поля](../../data/datasetfieldoptions.md) в выходном наборе данных.

* Тип данных - [тип данных](../../data/datatype.md) поля в выходном наборе данных.

* Промежуточное - при установке этого флага выражение может использоваться в расчетах, не включается в список полей выходного набора данных.

* Кэшировать - сохранение однажды вычисленного значения выражения, целесообразно при неоднократном использовании значений выражения последующими обработчиками и визуализаторами во избежание выполнения повторных вычислений. Также кэширование применяется при использовании в формуле функций, результат вычисления которых зависит от момента времени, в которое это вычисление происходит (например, RND(), TODAY() и др.). Кэшированные значения выражения занимают дополнительный объем памяти. Дополнительно см.  ["Кэширование"](../../scenario/caching.md).

* Описание - поясняющая информация.

При первом открытии мастера настройки список выражений содержит один элемент с именем "Expr0" вещественного типа. По умолчанию для нового выражения назначается метка ВыражениеN и имя ExprN, где N – номер, обеспечивающий уникальность.

После настройки параметров выражения в область кода требуется ввести рассчитываемую формулу.

### Область кода выражения

В области кода задается формула расчета выражения. Ссылки на поля/переменные и синтаксические конструкции функций можно вставлять в код выражения, выбрав их двойным кликом мыши в соответствующих областях или перетащив мышкой.

Изменения в области кода сохраняются при выходе из нее.

Формула выражения может содержать:

* ссылки на другие поля набора данных в виде наименования полей или ранее вычисленных выражений;

* ссылки на переменные входного порта;

* скобки, определяющие порядок выполнения операций;

* знаки математических операций и отношений;

* логические операции (and, or, not, xor) и значения (true или 1, false или 0);

* функции в соответствии с синтаксическим описанием (см. далее ["Список функций"](../calc-func/README.md));

* строковые выражения в кавычках ("строковое выражение");

* целые и вещественные числа;

* однострочные и многострочные комментарии.

Однострочный комментарий начинается символами // (два слеша) и продолжается до конца строки. Многострочным комментарием считаются все символы, содержащиеся между /* (слеш-звездочка) и */ (звездочка-слеш).

Пример комментария:

```java
// Пример однострочного комментария.

IF(IsNull(gate_one),gate_two,gate_one) // однострочный комментарий продолжается до конца строки.

/* Многострочным комментарием
   считаются все символы,
   содержащиеся между (слеш-звездочка)
   и (звездочка-слеш). */
```

### Поля/переменные

Область содержит список полей и переменных, передаваемых на вход обработчика. Перечень и параметры полей/переменных определяются при настройке входных портов обработчика.

Двойной клик мыши по позиции списка вводит имя поля/переменной в область кода выражения. То же самое можно сделать при помощи Drag-and-drop.

### Список функций

Наименование, входные аргументы и описание [доступных для использования функций](../calc-func/README.md).

Возможна фильтрация по категории и названию функции.

Двойной клик мыши по позиции выбранной функции вставляет ее синтаксис в область кода выражения. То же самое можно сделать при помощи Drag-and-drop.

----

**Примечание:**

Расчет значений выражений осуществляется построчно. В рамках одной строки сначала вычисляются выражения, находящиеся выше в списке выражений. В формуле выражения возможно использовать ссылки только на ранее вычисленные выражения, т.е. находящиеся выше по списку. В связи с этим неверная позиция в списке может приводить к ошибке.

Обработчик "Калькулятор" использует механизм ленивых вычислений[^1], это означает, что расчет производится только тогда, когда значение выражения отображается или используется другим узлом сценария.

Обработчик предназначен для транспонирования таблицы

[^1]: **Ленивые вычисления** – применяемая в программировании стратегия вычисления, согласно которой вычисления следует откладывать до тех пор, пока не понадобится их результат. Отложенные вычисления позволяют сократить общий объём вычислений за счёт тех вычислений, результаты которых не будут использованы.